<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"> <!--<![endif]-->
<head>

	<!-- Basic Page Needs
  ================================================== -->
	<meta charset="utf-8">
	<title>STIMMEN</title>
	<meta name="description" content="">
	<meta name="author" content="">

	<!-- Mobile Specific Metas
  ================================================== -->
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


	<!-- CSS
  ================================================== -->
	
	<link href='https://fonts.googleapis.com/css?family=Roboto:400,300italic,300,100italic,100,400italic,500,500italic,700,700italic,900,900italic' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="stylesheets/skeleton/base.css">
	<link rel="stylesheet" href="stylesheets/skeleton/skeleton.css">
	<link rel="stylesheet" href="stylesheets/skeleton/layout.css">
	<link href="stylesheets/jqUI-theme/jquery-ui-1.10.3.custom.min.css" rel="stylesheet">
	<link href="stylesheets/minicolors/jquery.minicolors.css" rel="stylesheet">
	<link href="stylesheets/core.css" rel="stylesheet">
	
	<!--[if lt IE 9]>
		<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	
  <!-- Javascript
  ================================================== -->
	<script language="javascript" type="text/javascript" src="js/vendor/jquery-1.10.2.min.js"></script>
	<script language="javascript" type="text/javascript" src="js/vendor/jquery-ui-1.10.3.custom.min.js"></script>
	<script language="javascript" type="text/javascript" src="js/vendor/jquery.ui.touch-punch.min.js"></script>
	<script language="javascript" type="text/javascript" src="js/vendor/jquery.minicolors.min.js"></script>
	<script language="javascript" type="text/javascript" src="js/vendor/socket.io.js"></script>
	<script language="javascript" type="text/javascript" src="js/core.js"></script>

</head>

<body>



<div class="one-third column">	

<!-- <h5>Result</h5>
<div id="resultHolder" class='text synchronizable' type="text" value="" data-vname="result">
</div> -->
			
<!-- </div>
<div id ="volume">
</dv> -->


<div id = "recordButton">
</div>

<div id = "deButton" class="langButton" type="de">
	DE
</div>

<div id = "enButton" class="langButton" type="en">
	EN
</div>

<div id = "ruButton" class="langButton" type="ru">
	RU
</div>

<script type="text/javascript">
	

var START_EV = " ";
var END_EV = " ";
var hasTouch = "ontouchstart" in window;

var active = false;
var lateSendTimeout;
var recognizer;

$( document ).ready(function() {
	recognizer = new webkitSpeechRecognition();

	START_EV = hasTouch ? "touchstart" : "mousedown";
	END_EV = hasTouch ? "touchend" : "mouseup";
	

	//alert(hasTouch);

	var speechArray = new Array();

	recognizer.lang = "de";
	recognizer.continuous = true;
	recognizer.interimResults = false;
	recognizer.onresult = function(event) {
		
	//speechArray = new Array();
		    
		    if (event.results.length > 0) {

	        var result = event.results[event.results.length-1];
	       
	        if(result.isFinal) {

	        	//$("#resultHolder").append( "result");

	        	clearTimeout(lateSendTimeout);

	           // console.log(result[0].transcript);
	           //console.log(event);

	        	
				speechArray.push(result[0].transcript);
				
				

				console.log(speechArray);

				if(!active) {
					sendMessage("result", speechArray);
					speechArray = new Array();
					//$("#resultHolder").append( " sent ");
				
				}
	        } 
	    }  
	};



	$("#recordButton").bind(START_EV, function(ev1){
		ev1.preventDefault();
		recognizer.start();
		active = true;
	
		
		$("#recordButton").css("background-color","red");
  		
  		
  		var valuearray = new Array();
		valuearray.push("start");
		sendMessage("record", valuearray);
		
		//$("#resultHolder").append( " start ");
	});


	$("#recordButton").bind(END_EV, function(ev2){
		ev2.preventDefault();
		recognizer.stop();
		active = false;

		$("#recordButton").css("background-color","black");

  		var valuearray = new Array();
		valuearray.push("stop");
		sendMessage("record", valuearray);

	
		lateSendTimeout = setTimeout(sendMessageLate, 5000);

		console.log("end");
		//sendMessage("result", speechArray);
		//$("#resultHolder").append( " end ");
	});


	function sendMessageLate(){
		sendMessage("result", speechArray);
		speechArray = new Array();
		//$("#resultHolder").append( " late send ");
	}

	// $( "#recordButton" ).mousedown(function() {
	// 	recognizer.start();

	// 	var valuearray = new Array();
	// 	valuearray.push("start");
	// 	sendMessage("record", valuearray);
		
	// });

	// $( "#recordButton" ).mouseup(function() {
	// 	sendMessage("result", speechArray);
	// 	recognizer.stop();	

	// 	var valuearray = new Array();
	// 	valuearray.push("stop");
	// 	sendMessage("record", valuearray);

	// 	speechArray = new Array();
	// });


	$( ".langButton" ).click(function(ev) {

		$( ".langButton" ).css("background-color","rgba(200,200,200,1)");
		$(ev.currentTarget).css("background-color","rgba(200,0,0,1)");

		var valuearray = new Array();
		valuearray.push(ev.currentTarget.getAttribute("TYPE"));
		sendMessage("lang", valuearray);

		recognizer.lang = ev.currentTarget.getAttribute("TYPE");

	});




	// var context = new AudioContext();

           

	//    // setup a javascript node
 //    javascriptNode = context.createScriptProcessor(2048, 1, 1);

	// //setupAudioNodes();

	// var aCtx;
	// var analyser;
	// var microphone;


	// if (navigator.webkitGetUserMedia) {
	//    navigator.webkitGetUserMedia({ audio: true},
	//       function(stream) {
	// 		aCtx = new AudioContext();
	// 		analyser = aCtx.createAnalyser();
	// 		microphone = aCtx.createMediaStreamSource(stream);
	// 		microphone.connect(analyser);
	// 		// analyser.connect(aCtx.destination);
	// 		process();
	//       },
	//       function(err) {
	//          console.log("The following error occured: " + err.name);
	//       }
	//    );
	// } else {
	//    console.log("getUserMedia not supported");
	// }


	// function process(){
	//     setInterval(function(){
	//         FFTData = new Float32Array(analyser.frequencyBinCount);
	//         analyser.getFloatFrequencyData(FFTData);
	//       //  console.log("       " + FFTData[0]);

	//       	var average = getAverageVolume(FFTData)
 			
 // 			$("#volume").css("height",""+ (average+150)*2 +"px");
	//       //console.log(average+200);

	//     },10);
	// }

 //    function getAverageVolume(array) {
 //        var values = 0;
 //        var average;
 
 //        var length = array.length;
 
 //        // get all the frequency amplitudes
 //        for (var i = 0; i < length; i++) {
 //            values += array[i];
 //        }
 
 //        average = values / length;
 //        return average;
 //    }


});


</script>



	
</body>
</html>