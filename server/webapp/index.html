<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"> <!--<![endif]-->
<head>

	<!-- Basic Page Needs
  ================================================== -->
	<meta charset="utf-8">
	<title>STIMMEN</title>
	<meta name="description" content="">
	<meta name="author" content="">

	<!-- Mobile Specific Metas
  ================================================== -->
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


	<!-- CSS
  ================================================== -->
	
	<link rel="stylesheet" href="stylesheets/skeleton/base.css">
	<link rel="stylesheet" href="stylesheets/skeleton/skeleton.css">
	<link rel="stylesheet" href="stylesheets/skeleton/layout.css">
	<link href="stylesheets/jqUI-theme/jquery-ui-1.10.3.custom.min.css" rel="stylesheet">
	<link href="stylesheets/minicolors/jquery.minicolors.css" rel="stylesheet">
	<link href="stylesheets/core.css" rel="stylesheet">
	
	<!--[if lt IE 9]>
		<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	
  <!-- Javascript
  ================================================== -->

	<script language="javascript" type="text/javascript" src="js/vendor/jquery-1.10.2.min.js"></script>
	<script language="javascript" type="text/javascript" src="js/vendor/jquery-ui-1.10.3.custom.min.js"></script>
	<script language="javascript" type="text/javascript" src="js/vendor/jquery.ui.touch-punch.min.js"></script>
	<script language="javascript" type="text/javascript" src="js/vendor/jquery.minicolors.min.js"></script>
	<script language="javascript" type="text/javascript" src="js/vendor/socket.io.js"></script>
	<script language="javascript" type="text/javascript" src="js/core.js"></script>
	<script language="javascript" type="text/javascript" src="js/easing.js"></script>

</head>

<body>



<!-- <div class="one-third column">	 -->

<!-- <h5>Result</h5>
<div id="resultHolder" class='text synchronizable' type="text" value="" data-vname="result">
</div> -->
			
<!-- </div>
<div id ="volume">
</dv> -->


<div id = "recordButton">
</div>

<div id = "sendButton">
  âœ“
</div>

<div id = "deButton" class="langButton" type="de">
	DE
</div>

<div id = "enButton" class="langButton" type="en">
	EN
</div>

<div id = "ruButton" class="langButton" type="ru">
	RU
</div>

<div id = "center">
	<div id = "wordHolder">
	</div>
</div>




<script type="text/javascript">
	

var START_EV = " ";
var END_EV = " ";
var hasTouch = "ontouchstart" in window;

var active = false;
var lateSendTimeout;
var recognizer;

var recordable = true;

function sendMessageLate(){
		sendMessage("result", speechArray);
		speechArray = new Array();
}


var speechArray = new Array();

$( document ).ready(function() {
	recognizer = new webkitSpeechRecognition();

	START_EV = hasTouch ? "touchstart" : "mousedown";
	END_EV = hasTouch ? "touchend" : "mouseup";
	

	recognizer.lang = "de";
	recognizer.continuous = true;
	recognizer.interimResults = false;
	recognizer.onresult = function(event) {
	
		    
		    if (event.results.length > 0) {

	        var result = event.results[event.results.length-1];
	       
	        if(result.isFinal) {

	        	clearTimeout(lateSendTimeout);

				speechArray.push(result[0].transcript);

				if(!active) {
					
					var splitted = speechArray[0].split(" ");

					splitted.forEach(function(entry) {
    					$("#wordHolder").append("<div class = 'word noselect'>"+ entry +"</div>");
					});

					// Reset Speech Array
					speechArray = new Array();


					$(".word").bind(START_EV, function(ev1){
						removeWord($(ev1.currentTarget));
					});

					var offsetArray = new Array();

					$(".word").each(function(index, value){
						offsetArray.push($(value).offset());
					});

					$(".word").each(function(index, value){
			
						var newOffset = offsetArray[index];
						$(value).css("position","absolute");
						$(value).offset(newOffset);
						$(value).css("top","+=100px");

						setTimeout(function(){
							$(value).css("opacity","1");
							$(value).animate({ top: '-=100px' }, 3000, 'easeOutElastic');

						}, map(index,0,$(".word").length,0,$(".word").length*100));

					});


					$("#sendButton").css("opacity","1");
					$("#sendButton").css("visibility","visible");
				

					$("#sendButton").bind(START_EV, function(ev){
						ev.preventDefault();

					$("#sendButton").css("background-color","red");
						console.log("send");
						sendWords();
						
						$( this ).unbind( ev );

					});

					$("#sendButton").bind(END_EV, function(ev){
						ev.preventDefault();

						$("#sendButton").css("background-color","lightGrey");
						
						setTimeout(function(){
							$("#sendButton").css("opacity","0");
						}, 300);

						setTimeout(function(){
							$("#sendButton").css("visibility","hidden");
						}, 600);

						$( this ).unbind( ev );

					});

					
				
				}
	        } 
	    }  
	};



	$("#recordButton").bind(START_EV, function(ev1){
		
		ev1.preventDefault();
		if(!recordable) return;		

		recognizer.start();
		active = true;
		
		$("#recordButton").css("background-color","red");
  			
  		var valuearray = new Array();
		valuearray.push("start");
		sendMessage("record", valuearray);
		
	});


	$("#recordButton").bind(END_EV, function(ev2){
		ev2.preventDefault();
		if(!recordable || !active) return;

		recognizer.stop();
		active = false;
		recordable = false;

		$("#recordButton").css("background-color","LightGrey");

  		var valuearray = new Array();
		valuearray.push("stop");
		sendMessage("record", valuearray);

	
		//lateSendTimeout = setTimeout(sendMessageLate, 5000);

		console.log("end");
	});



	$( ".langButton" ).click(function(ev) {

		$( ".langButton" ).css("background-color","rgba(200,200,200,1)");
		$(ev.currentTarget).css("background-color","rgba(200,0,0,1)");

		var valuearray = new Array();
		valuearray.push(ev.currentTarget.getAttribute("TYPE"));
		sendMessage("lang", valuearray);

		recognizer.lang = ev.currentTarget.getAttribute("TYPE");

	});




	// var context = new AudioContext();

           

			//    // setup a javascript node
		 //    javascriptNode = context.createScriptProcessor(2048, 1, 1);

			// //setupAudioNodes();

			// var aCtx;
			// var analyser;
			// var microphone;


			// if (navigator.webkitGetUserMedia) {
			//    navigator.webkitGetUserMedia({ audio: true},
			//       function(stream) {
			// 		aCtx = new AudioContext();
			// 		analyser = aCtx.createAnalyser();
			// 		microphone = aCtx.createMediaStreamSource(stream);
			// 		microphone.connect(analyser);
			// 		// analyser.connect(aCtx.destination);
			// 		process();
			//       },
			//       function(err) {
			//          console.log("The following error occured: " + err.name);
			//       }
			//    );
			// } else {
			//    console.log("getUserMedia not supported");
			// }


			// function process(){
			//     setInterval(function(){
			//         FFTData = new Float32Array(analyser.frequencyBinCount);
			//         analyser.getFloatFrequencyData(FFTData);
			//       //  console.log("       " + FFTData[0]);

			//       	var average = getAverageVolume(FFTData)
		 			
		 // 			$("#volume").css("height",""+ (average+150)*2 +"px");
			//       //console.log(average+200);

			//     },10);
			// }

		 //    function getAverageVolume(array) {
		 //        var values = 0;
		 //        var average;
		 
		 //        var length = array.length;
		 
		 //        // get all the frequency amplitudes
		 //        for (var i = 0; i < length; i++) {
		 //            values += array[i];
		 //        }
		 
		 //        average = values / length;
		 //        return average;
		 //    }


});

function map(value, oldMin, oldMax, newMin, newMax){
	
	return (value - oldMin) / (oldMax - oldMin) * (newMax - newMin) + newMin;	
}

var randomAddition;

function removeWord(object){
	$(object).each(function(index, value){
		// console.log($(object).length);
		// console.log(map(index,0,$(object).length,0,$(object).length*1000));
		// console.log(value);
		setTimeout(function(){
			
			if($(object).length > 1){
				randomAddition = Math.random() * 300;
			} else {
				randomAddition = 0;
			}
			
			$(value).css("opacity","0");
		
			$(value).css("transform", "translate3d(0px,10px,-300px) rotateY(80deg) rotateZ(30deg)");

			setTimeout(function(){
				$(value).remove();
			},750);

		}, map(index,0,$(object).length,0,$(object).length*10+(randomAddition)));

	});
}

function sendWords(){

	var valuearray = new Array();
	$(".word").each(function(index, value){
		if(index < $(".word").length-1){
			valuearray.push($(value)[0].innerHTML+" ");
		} else {
			valuearray.push($(value)[0].innerHTML);
		}
		
	});
	
	console.log(valuearray);
	sendMessage("result", valuearray);


	
}


</script>



	
</body>
</html>